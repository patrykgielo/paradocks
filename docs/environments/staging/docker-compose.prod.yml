# Docker Compose Production Configuration
# Environment: Staging VPS (72.60.17.138)
# Last Updated: 2025-11-11
#
# This is the ACTUAL docker-compose configuration deployed on staging.
# It reflects all workarounds and decisions made during deployment.
#
# Related Documentation:
# - Configuration Details: 02-CONFIGURATIONS.md
# - Deployment Log: 01-DEPLOYMENT-LOG.md
# - ADR-002: Storage Volume Removal (why bind mounts instead of volumes)

version: '3.8'

services:
  # PHP-FPM Application Container
  app:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    image: paradocks-app:latest
    container_name: paradocks-app
    restart: unless-stopped
    working_dir: /var/www/html
    environment:
      - APP_ENV=${APP_ENV}
      - APP_DEBUG=${APP_DEBUG}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
    volumes:
      # Main application code
      - ./:/var/www/html

      # Storage directories (bind mounts, not volumes - see ADR-002)
      # Permissions: 775, ubuntu:ubuntu (1000:1000)
      - ./storage:/var/www/html/storage
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    networks:
      - paradocks_network
    depends_on:
      - mysql
      - redis
    healthcheck:
      test: ["CMD", "php", "-v"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx Web Server
  nginx:
    image: nginx:1.25-alpine
    container_name: paradocks-nginx
    restart: unless-stopped
    ports:
      - "80:80"    # HTTP
      - "443:443"  # HTTPS (not configured yet - see 07-NEXT-STEPS.md)
    volumes:
      # Application code (for static files)
      - ./:/var/www/html

      # Nginx configuration (custom, no paradocks-node references - see 01-DEPLOYMENT-LOG.md)
      - ./docker/nginx/app.prod.conf:/etc/nginx/conf.d/default.conf

      # Public directory (static assets)
      - ./public:/var/www/html/public
    networks:
      - paradocks_network
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: paradocks-mysql
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      # Exposed for external tools (MySQL Workbench, etc.)
      # Protected by UFW + ufw-docker (see ADR-001)
      # Also password-protected (see 03-CREDENTIALS.md)
      - "3306:3306"
    volumes:
      # Persistent database storage (Docker volume - appropriate for database)
      - paradocks_mysql-data:/var/lib/mysql

      # MySQL configuration
      - ./docker/mysql/my.cnf:/etc/mysql/conf.d/my.cnf
    networks:
      - paradocks_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Redis Cache/Queue/Sessions
  redis:
    image: redis:7.2-alpine
    container_name: paradocks-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      # Exposed for external tools (RedisInsight, etc.)
      # Protected by UFW + ufw-docker (see ADR-001)
      # Also password-protected (see 03-CREDENTIALS.md)
      - "6379:6379"
    networks:
      - paradocks_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Laravel Horizon (Queue Worker Manager)
  horizon:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    image: paradocks-app:latest
    container_name: paradocks-horizon
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan horizon
    environment:
      - APP_ENV=${APP_ENV}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
    volumes:
      - ./:/var/www/html
    networks:
      - paradocks_network
    depends_on:
      - mysql
      - redis
    healthcheck:
      test: ["CMD", "php", "artisan", "horizon:status"]
      interval: 60s
      timeout: 10s
      retries: 3

  # Laravel Scheduler (Cron Replacement)
  scheduler:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    image: paradocks-app:latest
    container_name: paradocks-scheduler
    restart: unless-stopped
    working_dir: /var/www/html
    # Runs schedule:run every 60 seconds
    command: /bin/sh -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    environment:
      - APP_ENV=${APP_ENV}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_PORT=${REDIS_PORT}
    volumes:
      - ./:/var/www/html
    networks:
      - paradocks_network
    depends_on:
      - mysql
      - redis

# Network Configuration
networks:
  paradocks_network:
    driver: bridge
    # Internal DNS resolution allows services to reach each other by name
    # Example: app can connect to mysql via hostname "mysql"

# Volume Configuration
volumes:
  # MySQL persistent storage
  # Only volume we keep (database data should use volumes)
  # Application storage uses bind mounts (see ADR-002)
  paradocks_mysql-data:
    driver: local
    # Data stored in: /var/lib/docker/volumes/paradocks_mysql-data/_data

# IMPORTANT NOTES:
#
# 1. Storage Volumes Removed (ADR-002):
#    - Originally had: paradocks_storage volume
#    - Removed due to permission issues
#    - Now using bind mounts: ./storage:/var/www/html/storage
#    - Set host permissions: chmod -R 775 storage && chown -R ubuntu:ubuntu storage
#
# 2. Firewall Security (ADR-001):
#    - Ports 3306 and 6379 are exposed
#    - Protected by ufw-docker integration
#    - Also protected by strong passwords
#    - See: /usr/local/bin/ufw-docker
#
# 3. Environment Variables:
#    - All loaded from .env file (NOT committed to Git)
#    - See: 03-CREDENTIALS.md for actual values
#    - See: 02-CONFIGURATIONS.md for full configuration reference
#
# 4. Service Dependencies:
#    - app depends on mysql, redis
#    - nginx depends on app
#    - horizon depends on mysql, redis
#    - scheduler depends on mysql, redis
#    - Startup order handled by depends_on
#
# 5. Health Checks:
#    - All critical services have health checks
#    - Use: docker-compose ps to see health status
#    - Automatic restart if health check fails (restart: unless-stopped)
#
# 6. Commands Reference:
#    - Start:   docker-compose -f docker-compose.prod.yml up -d
#    - Stop:    docker-compose -f docker-compose.prod.yml down
#    - Restart: docker-compose -f docker-compose.prod.yml restart
#    - Logs:    docker-compose -f docker-compose.prod.yml logs -f
#    - Status:  docker-compose -f docker-compose.prod.yml ps
#
# For detailed service management, see: 04-SERVICES.md
