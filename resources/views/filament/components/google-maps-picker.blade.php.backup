@php
    $mapId = 'map-' . uniqid();
    $record = $getRecord();
    $latitude = $record?->latitude ?? 52.2297; // Default Warsaw
    $longitude = $record?->longitude ?? 21.0122;
    $radiusKm = $record?->radius_km ?? 50; // Default 50km
    $colorHex = $record?->color_hex ?? '#4CAF50';
    $googleMapsApiKey = config('services.google_maps.api_key');
@endphp

{{-- Load Google Maps API if not already loaded --}}
@once
    @push('scripts')
    <script>
        // Check if Google Maps is already loaded
        if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key={{ $googleMapsApiKey }}&libraries=places';
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>
    @endpush
@endonce

<div x-data="{
    ...googleMapsPicker('{{ $mapId }}', {{ $latitude }}, {{ $longitude }}, {{ $radiusKm }}, '{{ $colorHex }}'),
    showInstructions: false
}" class="space-y-8">

    {{-- Collapsible Instructions Card --}}
    <div class="rounded-lg overflow-hidden border border-primary-300 dark:border-primary-700/50">
        <button
            type="button"
            @click="showInstructions = !showInstructions"
            class="w-full flex items-center justify-between gap-3 p-4 bg-primary-50 dark:bg-primary-950/50 hover:bg-primary-100 dark:hover:bg-primary-950 transition-colors"
        >
            <div class="flex items-center gap-3">
                <x-filament::icon
                    icon="heroicon-o-information-circle"
                    class="h-5 w-5 text-primary-600 dark:text-primary-400 flex-shrink-0"
                />
                <h4 class="text-sm font-semibold text-primary-900 dark:text-primary-100">
                    Jak ustawiƒá obszar obs≈Çugi
                </h4>
            </div>
            <x-filament::icon
                icon="heroicon-m-chevron-down"
                class="h-5 w-5 text-primary-600 dark:text-primary-400 transition-transform"
                ::class="{ 'rotate-180': showInstructions }"
            />
        </button>

        <div
            x-show="showInstructions"
            x-collapse
            class="bg-white dark:bg-gray-800 border-t border-primary-200 dark:border-primary-800"
        >
            <ul class="p-4 space-y-3 text-sm text-gray-700 dark:text-gray-300">
                <li class="flex items-start gap-3">
                    <x-filament::icon icon="heroicon-m-map-pin" class="h-5 w-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" />
                    <span>Kliknij na mapie lub przeciƒÖgnij czerwony marker, aby ustawiƒá ≈õrodek obszaru</span>
                </li>
                <li class="flex items-start gap-3">
                    <x-filament::icon icon="heroicon-m-magnifying-glass" class="h-5 w-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" />
                    <span>U≈ºyj pola wyszukiwania poni≈ºej, aby znale≈∫ƒá konkretny adres lub miejsce</span>
                </li>
                <li class="flex items-start gap-3">
                    <x-filament::icon icon="heroicon-m-arrows-pointing-out" class="h-5 w-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" />
                    <span>Wprowad≈∫ promie≈Ñ obszaru (1-200 km) i kliknij "Zaktualizuj" lub naci≈õnij Enter</span>
                </li>
                <li class="flex items-start gap-3">
                    <x-filament::icon icon="heroicon-m-eye" class="h-5 w-5 mt-0.5 flex-shrink-0 text-primary-600 dark:text-primary-400" />
                    <span>Ko≈Ço na mapie pokazuje zasiƒôg obszaru obs≈Çugi widoczny dla klient√≥w</span>
                </li>
            </ul>
        </div>
    </div>

    {{-- Search Input --}}
    <div class="space-y-2">
        <label class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white">
            <x-filament::icon icon="heroicon-o-magnifying-glass" class="h-5 w-5" />
            Wyszukaj adres lub miejsce
        </label>
        <x-filament::input
            type="text"
            x-ref="searchInput"
            placeholder="np. Plac Defilad 1, Warszawa"
            class="text-base"
        />
        <p class="text-xs text-gray-600 dark:text-gray-400">
            Zacznij wpisywaƒá nazwƒô miejsca lub adres, aby wy≈õwietliƒá podpowiedzi
        </p>
    </div>

    {{-- Map Container - LARGE FULL WIDTH --}}
    <div class="overflow-hidden rounded-lg border-2 border-gray-300 dark:border-gray-600 shadow-lg">
        <div
            id="{{ $mapId }}"
            class="w-full h-[600px]"
            style="min-height: 600px;"
            wire:ignore
        ></div>
    </div>

    {{-- Radius Control - Enhanced Design --}}
    <div class="rounded-lg bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 p-6 shadow-md ring-1 ring-gray-950/5 dark:ring-white/10">
        <div class="flex flex-col sm:flex-row sm:items-end gap-4">
            <div class="flex-1 space-y-2">
                <label class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white">
                    <x-filament::icon icon="heroicon-o-arrows-pointing-out" class="h-5 w-5 text-primary-600 dark:text-primary-400" />
                    Promie≈Ñ obszaru obs≈Çugi
                </label>
                <div class="relative">
                    <x-filament::input
                        type="number"
                        x-model.number="currentRadius"
                        @keydown.enter="updateCircleRadius()"
                        min="1"
                        max="200"
                        step="1"
                        placeholder="np. 50"
                        class="text-lg font-semibold pr-12"
                    />
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-sm font-medium text-gray-500 dark:text-gray-400 pointer-events-none">
                        km
                    </div>
                </div>
                <p class="text-xs text-gray-600 dark:text-gray-400">
                    Wprowad≈∫ promie≈Ñ w kilometrach (1-200 km) i kliknij "Zaktualizuj" lub naci≈õnij Enter
                </p>
            </div>

            <button
                type="button"
                @click.prevent="updateCircleRadius()"
                style="pointer-events: auto !important; position: relative; z-index: 10;"
                class="fi-btn fi-size-lg relative inline-grid grid-flow-col items-center justify-center font-semibold outline-none transition duration-75 focus-visible:ring-2 rounded-lg gap-1.5 px-4 py-3 text-sm shadow-sm ring-1 bg-primary-600 text-white hover:bg-primary-500 focus-visible:ring-primary-500/50 dark:bg-primary-500 dark:hover:bg-primary-400 dark:focus-visible:ring-primary-400/50 ring-primary-600 dark:ring-primary-500 whitespace-nowrap"
            >
                <x-filament::icon
                    icon="heroicon-o-arrow-path"
                    class="fi-btn-icon h-5 w-5"
                    style="pointer-events: none;"
                />
                <span class="fi-btn-label" style="pointer-events: none;">
                    Zaktualizuj zasiƒôg
                </span>
            </button>
        </div>
    </div>

    {{-- Current Coordinates Display - Enhanced --}}
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div class="rounded-lg bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900/50 dark:to-gray-900 p-5 ring-1 ring-gray-950/5 dark:ring-white/10 shadow-sm">
            <div class="flex items-center gap-2 mb-3">
                <x-filament::icon icon="heroicon-o-arrows-up-down" class="h-5 w-5 text-primary-600 dark:text-primary-400" />
                <span class="text-xs font-semibold uppercase tracking-wider text-gray-700 dark:text-gray-300">
                    Szeroko≈õƒá geograficzna
                </span>
            </div>
            <div x-text="currentLat.toFixed(7)" class="text-lg font-mono font-bold text-gray-900 dark:text-white"></div>
        </div>
        <div class="rounded-lg bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-900/50 dark:to-gray-900 p-5 ring-1 ring-gray-950/5 dark:ring-white/10 shadow-sm">
            <div class="flex items-center gap-2 mb-3">
                <x-filament::icon icon="heroicon-o-arrows-right-left" class="h-5 w-5 text-primary-600 dark:text-primary-400" />
                <span class="text-xs font-semibold uppercase tracking-wider text-gray-700 dark:text-gray-300">
                    D≈Çugo≈õƒá geograficzna
                </span>
            </div>
            <div x-text="currentLng.toFixed(7)" class="text-lg font-mono font-bold text-gray-900 dark:text-white"></div>
        </div>
    </div>
</div>

@push('scripts')
<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('googleMapsPicker', (mapId, initialLat, initialLng, initialRadius, initialColor) => ({
        map: null,
        marker: null,
        circle: null,
        currentLat: initialLat,
        currentLng: initialLng,
        currentRadius: initialRadius,
        currentColor: initialColor,

        init() {
            // Wait for Google Maps to load
            const initMap = () => {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                    setTimeout(initMap, 100);
                    return;
                }
                this.initializeMap();
            };
            initMap();
        },

        initializeMap() {
            // Initialize map
            this.map = new google.maps.Map(document.getElementById(mapId), {
                center: { lat: this.currentLat, lng: this.currentLng },
                zoom: 12,
                mapTypeControl: true,
                streetViewControl: false,
                fullscreenControl: true,
            });

            // Add marker with custom icon (smaller size)
            this.marker = new google.maps.Marker({
                position: { lat: this.currentLat, lng: this.currentLng },
                map: this.map,
                draggable: true,
                title: '≈örodek obszaru obs≈Çugi',
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: '#FF0000',
                    fillOpacity: 1,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF',
                }
            });

            // Add service area circle
            this.circle = new google.maps.Circle({
                strokeColor: this.currentColor,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: this.currentColor,
                fillOpacity: 0.15,
                map: this.map,
                center: { lat: this.currentLat, lng: this.currentLng },
                radius: this.currentRadius * 1000, // Convert km to meters
            });

            // Fit map to circle bounds
            this.map.fitBounds(this.circle.getBounds());

            // Click on map to set position
            this.map.addListener('click', (event) => {
                this.updatePosition(event.latLng.lat(), event.latLng.lng());
            });

            // Drag marker to set position
            this.marker.addListener('dragend', (event) => {
                this.updatePosition(event.latLng.lat(), event.latLng.lng());
            });

            // Initialize search autocomplete
            if (this.$refs.searchInput) {
                const autocomplete = new google.maps.places.Autocomplete(this.$refs.searchInput, {
                    fields: ['geometry', 'name'],
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (place.geometry) {
                        const lat = place.geometry.location.lat();
                        const lng = place.geometry.location.lng();
                        this.updatePosition(lat, lng);
                        this.map.setCenter({ lat, lng });
                        this.map.setZoom(14);
                    }
                });
            }

            // NOTE: Watcher REMOVED to prevent infinite loop with Livewire
            // Manual updates are triggered by Enter key or button click only

            console.log('‚úÖ Map initialized successfully. Circle radius:', this.circle.getRadius() / 1000, 'km');
        },

        updatePosition(lat, lng) {
            this.currentLat = lat;
            this.currentLng = lng;

            // Update marker position
            this.marker.setPosition({ lat, lng });

            // Update circle position
            if (this.circle) {
                this.circle.setCenter({ lat, lng });
            }

            // Update form fields via Livewire
            this.$wire.set('data.latitude', lat);
            this.$wire.set('data.longitude', lng);
        },

        updateCircleRadius() {
            console.log('üìç üö® updateCircleRadius() CALLED! üö®');
            console.log('   Event source:', event?.type || 'unknown');
            console.log('   currentRadius value:', this.currentRadius, '(type:', typeof this.currentRadius, ')');
            console.log('   circle exists?', this.circle !== null);

            // Guard clause - ensure circle exists
            if (!this.circle) {
                console.error('‚ùå Circle not initialized!');
                return;
            }

            // Validate and convert
            const radiusValue = parseFloat(this.currentRadius);
            console.log('   Parsed radius:', radiusValue);

            if (isNaN(radiusValue) || radiusValue < 1) {
                console.warn('‚ùå Invalid radius value:', radiusValue);
                return;
            }

            // Update circle radius (convert km to meters)
            const radiusMeters = radiusValue * 1000;
            console.log('   Setting circle radius to:', radiusMeters, 'meters (', radiusValue, 'km)');
            this.circle.setRadius(radiusMeters);

            // Verify the update
            const actualRadius = this.circle.getRadius();
            console.log('   ‚úÖ Circle radius after update:', actualRadius, 'meters (', (actualRadius / 1000).toFixed(1), 'km)');

            // Sync with Livewire form field WITHOUT triggering re-render (false = no re-render)
            this.$wire.set('data.radius_km', radiusValue, false);
            console.log('   üíæ Synced with Livewire (no re-render)');

            // Fit map to new circle bounds
            const bounds = this.circle.getBounds();
            if (bounds) {
                this.map.fitBounds(bounds);
                console.log('   ‚úÖ Map bounds updated and fitted');
            }
        },

        updateCircleColor() {
            if (!this.circle) return;

            // Update circle color
            this.circle.setOptions({
                strokeColor: this.currentColor,
                fillColor: this.currentColor,
            });
        }
    }));
});
</script>
@endpush
